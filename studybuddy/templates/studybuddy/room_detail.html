{% extends 'studybuddy/base.html' %}
{% block title %}{{ room.name }}{% endblock %}
{% block content %}
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
    <h2 style="margin:0;">{{ room.name }}</h2>
    <div style="display:flex;align-items:center;gap:15px;">
        <div id="active-users-badge" style="background:linear-gradient(135deg, var(--accent-primary), var(--accent-hover));color:white;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px;box-shadow:0 2px 8px var(--shadow);">
            <i class="fas fa-users"></i>
            <span id="active-user-count">1</span>
            <span>online</span>
        </div>
        {% if room.created_by == request.user %}
        <a href="{% url 'studybuddy:room_delete' room.id %}" 
           style="background-color:#dc2626;color:white;padding:8px 16px;border-radius:8px;text-decoration:none;font-size:14px;">
            Delete Room
        </a>
        {% endif %}
    </div>
</div>

{% if room.created_by == request.user %}
<div id="privacy-controls" style="margin-bottom:20px;padding:15px;background-color:var(--bg-tertiary);border-radius:10px;border:2px solid var(--border-color);">
    <p id="privacy-status" style="margin:0 0 10px 0;color:var(--text-primary);">
        This room is currently <strong>{% if room.is_private %}private{% else %}public{% endif %}</strong>.
        {% if room.is_private and room.password %}
        <br><span style="font-size:0.9em;color:var(--success);margin-top:8px;display:inline-block;">
            Room Code: <strong style="font-size:1.2em;letter-spacing:2px;background-color:var(--bg-tertiary);padding:4px 8px;border-radius:4px;border:2px solid var(--success);">{{ room.password }}</strong>
        </span>
        {% endif %}
    </p>
    <button id="togglePrivacyBtn"
            style="background-color:{% if room.is_private %}#16a34a{% else %}#2563eb{% endif %};color:white;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;">
        {% if room.is_private %}Make Public{% else %}Make Private{% endif %}
    </button>
    <p id="privacyError" style="display:none;color:#dc2626;margin-top:8px;"></p>
    <p id="privacySuccess" style="display:none;color:#059669;margin-top:8px;"></p>
</div>
{% else %}
<div style="margin-bottom:20px;padding:12px;border-radius:8px;background-color:#f3f4f6;color:#374151;">
    This room is {% if room.is_private %}<strong>private</strong>{% else %}<strong>public</strong>{% endif %}.
</div>
{% endif %}

<div style="display:flex;gap:20px;">
    <!-- Chat Section -->
    <div style="flex:2;">
        <div id="chat-messages" style="border:1px solid #ddd;padding:15px;border-radius:8px;height:400px;overflow-y:auto;margin-bottom:15px;">
            {% for message in messages %}
                <div data-message-id="{{ message.id }}" data-timestamp-iso="{{ message.timestamp|date:'c' }}" style="margin-bottom:15px;padding:10px 15px;border-radius:10px;max-width:70%;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;position:relative;
                    {% if message.user == request.user %}background:linear-gradient(135deg, var(--accent-primary), var(--accent-hover));color:white;margin-left:auto;{% else %}background-color:var(--bg-tertiary);color:var(--text-primary);{% endif %}">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div style="flex:1;">
                            <strong>{{ message.user.username }}</strong><br>
                            {{ message.content }}
                            <div class="message-timestamp" style="font-size:0.8em;{% if message.user == request.user %}color:rgba(255,255,255,0.8);{% else %}color:var(--text-secondary);{% endif %}margin-top:4px;">
                                {{ message.timestamp|date:"M d, Y H:i" }}
                            </div>
                        </div>
                        {% if message.user == request.user %}
                        <button type="button" 
                                onclick="deleteMessage({{ message.id }})"
                                style="background-color:transparent;border:none;color:white;cursor:pointer;font-size:18px;padding:0;line-height:1;margin-left:10px;"
                                title="Delete message">
                            Ã—
                        </button>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p id="no-messages">No messages yet. Start the conversation!</p>
            {% endfor %}
        </div>

        <form id="message-form" style="display:flex;align-items:center;">
            {% csrf_token %}
            <textarea id="message-input" name="content" rows="2" placeholder="Type your message..." required
                      maxlength="1000"
                      style="flex:1;resize:none;padding:10px;border-radius:8px;border:1px solid var(--border-color);font-family:inherit;word-wrap:break-word;overflow-wrap:break-word;background-color:var(--bg-tertiary);color:var(--text-primary);"></textarea>
            <button type="submit"
                    style="background:linear-gradient(135deg, var(--accent-primary), var(--accent-hover));border:none;color:white;padding:10px 20px;border-radius:8px;margin-left:10px;cursor:pointer;transition:all 0.3s ease;">
                Send
            </button>
        </form>
        <div id="char-counter" style="font-size:0.85em;color:var(--text-secondary);margin-top:5px;text-align:right;">
            <span id="current-chars">0</span>/1000 characters
        </div>
    </div>

    <!-- Pomodoro Timer Section -->
    <div style="flex:1;min-width:250px;">
        <div style="border:2px solid var(--border-color);padding:20px;border-radius:8px;background-color:var(--bg-tertiary);">
            <h3 style="margin-top:0;text-align:center;color:var(--text-primary);">Pomodoro Timer</h3>
            {% if room.created_by != request.user %}
            <div style="background-color:var(--warning);padding:8px;border-radius:6px;margin-bottom:15px;text-align:center;font-size:12px;color:var(--bg-primary);opacity:0.9;">
                Only {{ room.created_by.username }} (room creator) can control the timer
            </div>
            {% endif %}
            
            <!-- Timer Character -->
            <div style="text-align:center;margin:10px 0;">
                <svg id="timer-character" class="character" width="70" height="82" viewBox="0 0 120 140" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
                    <!-- Head (clock face) -->
                    <circle cx="60" cy="40" r="25" fill="#87CEEB" stroke="#4682B4" stroke-width="3"/>
                    <circle cx="60" cy="40" r="20" fill="white"/>
                    
                    <!-- Clock markings -->
                    <circle cx="60" cy="28" r="2" fill="#4682B4"/>
                    <circle cx="72" cy="40" r="2" fill="#4682B4"/>
                    <circle cx="60" cy="52" r="2" fill="#4682B4"/>
                    <circle cx="48" cy="40" r="2" fill="#4682B4"/>
                    
                    <!-- Headband -->
                    <g class="headband">
                        <ellipse cx="60" cy="22" rx="28" ry="4" fill="#FF4500"/>
                        <circle cx="75" cy="22" r="4" fill="#FFD700"/>
                    </g>
                    
                    <!-- Happy eyes -->
                    <path d="M 53 36 Q 55 34 57 36" stroke="#000" stroke-width="2" fill="none"/>
                    <path d="M 63 36 Q 65 34 67 36" stroke="#000" stroke-width="2" fill="none"/>
                    
                    <!-- Big smile -->
                    <path d="M 50 44 Q 60 50 70 44" stroke="#FF6347" stroke-width="2" fill="none"/>
                    
                    <!-- Body -->
                    <rect x="45" y="62" width="30" height="35" rx="8" fill="#87CEEB"/>
                    
                    <!-- Arms -->
                    <g id="left-arm">
                        <ellipse cx="37" cy="75" rx="5" ry="20" fill="#87CEEB"/>
                        <circle cx="35" cy="92" r="6" fill="#FFB6C1"/>
                        <text x="33" y="95" font-size="10">ðŸ’ª</text>
                    </g>
                    <g id="right-arm">
                        <ellipse cx="83" cy="75" rx="5" ry="20" fill="#87CEEB"/>
                        <circle cx="85" cy="92" r="6" fill="#FFB6C1"/>
                        <text x="83" y="95" font-size="10">ðŸ’ª</text>
                    </g>
                    
                    <!-- Legs -->
                    <g id="left-leg">
                        <rect x="48" y="97" width="8" height="25" rx="4" fill="#87CEEB"/>
                        <ellipse cx="52" cy="125" rx="9" ry="5" fill="#000"/>
                    </g>
                    <g id="right-leg">
                        <rect x="64" y="97" width="8" height="25" rx="4" fill="#87CEEB"/>
                        <ellipse cx="68" cy="125" rx="9" ry="5" fill="#000"/>
                    </g>
                </svg>
            </div>
            
            <div id="timer-display" style="font-size:48px;font-weight:bold;text-align:center;margin:10px 0;color:var(--accent-primary);">
                25:00
            </div>
            
            <div style="text-align:center;margin-bottom:15px;">
                <span id="timer-mode" style="font-size:16px;color:var(--text-secondary);">Work Session</span>
            </div>
            
            {% if room.created_by == request.user %}
            <div style="display:flex;flex-direction:column;gap:10px;">
                <button id="start-btn" onclick="startTimer()" 
                        style="background:linear-gradient(135deg, var(--success), #047857);color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;transition:all 0.3s ease;">
                    Start
                </button>
                <button id="pause-btn" onclick="pauseTimer()" 
                        style="background:linear-gradient(135deg, var(--warning), #d97706);color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;display:none;transition:all 0.3s ease;">
                    Pause
                </button>
                <button onclick="resetTimer()" 
                        style="background:linear-gradient(135deg, #6b7280, #4b5563);color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;transition:all 0.3s ease;">
                    Reset
                </button>
            </div>
            {% else %}
            <div style="text-align:center;padding:12px;background-color:var(--bg-secondary);border-radius:8px;color:var(--text-secondary);font-size:14px;border:1px solid var(--border-color);">
                Timer controlled by room creator
            </div>
            {% endif %}
            
            <div style="margin-top:15px;padding:10px;background-color:var(--bg-secondary);border-radius:8px;font-size:14px;border:1px solid var(--border-color);">
                <strong style="color:var(--text-primary);">Settings:</strong><br>
                <span style="color:var(--text-primary);">Work: 25 min<br>
                Break: 5 min</span><br>
                <div style="margin-top:5px;font-size:12px;color:var(--text-secondary);">
                    <em>Synced across all users in room</em>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const ROOM_ID = {{ room.id }};
const IS_CREATOR = {{ room.created_by.id }} === {{ request.user.id }};
let pollInterval = null;
let messagePollInterval = null;
let presencePollInterval = null;
let lastMode = 'work';
let lastMessageId = null;
const privacyEndpoint = `/studybuddy/room/${ROOM_ID}/set_privacy/`;
let roomIsPrivate = {{ room.is_private|yesno:"true,false" }};
const togglePrivacyBtn = document.getElementById('togglePrivacyBtn');
const privacyStatus = document.getElementById('privacy-status');
const privacyError = document.getElementById('privacyError');
const privacySuccess = document.getElementById('privacySuccess');

if (togglePrivacyBtn) {
    togglePrivacyBtn.addEventListener('click', () => {
        if (roomIsPrivate) {
            updateRoomPrivacy({ is_private: 'false' });
        } else {
            // Auto-generate code - no password input needed
            updateRoomPrivacy({ is_private: 'true' });
        }
    });
}

// Function to broadcast privacy changes to other tabs
function broadcastPrivacyChange(isPrivate) {
    // Broadcast privacy change to other tabs using BroadcastChannel
    if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('room_privacy_updates');
        channel.postMessage({
            type: 'privacy_changed',
            room_id: ROOM_ID,
            is_private: isPrivate
        });
        channel.close();
    }
    
    // Also use localStorage as fallback for older browsers
    localStorage.setItem('room_privacy_update', JSON.stringify({
        room_id: ROOM_ID,
        is_private: isPrivate,
        timestamp: Date.now()
    }));
}

// Intercept fetch calls to set_privacy endpoint to broadcast changes
const originalFetch = window.fetch;
window.fetch = async function(...args) {
    const response = await originalFetch.apply(this, args);
    
    // Check if this is a call to set_privacy endpoint
    if (args[0] && typeof args[0] === 'string' && args[0].includes('/set_privacy/')) {
        // Clone the response so we can read it without consuming it
        const clonedResponse = response.clone();
        try {
            const data = await clonedResponse.json();
            if (data.success && data.is_private !== undefined) {
                // Broadcast the privacy change
                broadcastPrivacyChange(data.is_private);
            }
        } catch (e) {
            // Response might not be JSON, ignore
        }
    }
    
    return response;
};

async function updateRoomPrivacy(payload) {
    if (!togglePrivacyBtn) {
        return;
    }

    if (privacyError) {
        privacyError.style.display = 'none';
        privacyError.textContent = '';
    }
    if (privacySuccess) {
        privacySuccess.style.display = 'none';
        privacySuccess.textContent = '';
    }

    const formData = new FormData();
    Object.entries(payload).forEach(([key, value]) => formData.append(key, value));

    try {
        const response = await fetch(privacyEndpoint, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData,
        });
        const data = await response.json();
        if (!response.ok || !data.success) {
            if (privacyError) {
                privacyError.textContent = data.error || 'Unable to update privacy settings.';
                privacyError.style.display = 'block';
            }
            return;
        }
        
        // If room was made private, show the generated code
        if (data.is_private && data.code) {
            roomIsPrivate = true;
            // Update the status to show the code
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success').trim();
            const bgTertiary = getComputedStyle(document.documentElement).getPropertyValue('--bg-tertiary').trim();
            if (privacyStatus) {
                privacyStatus.innerHTML = `This room is currently <strong>private</strong>.<br>
                    <span style="font-size:0.9em;color:${successColor};margin-top:8px;display:inline-block;">
                        Room Code: <strong style="font-size:1.2em;letter-spacing:2px;background-color:${bgTertiary};padding:4px 8px;border-radius:4px;border:2px solid ${successColor};">${data.code}</strong>
                    </span>`;
            }
            if (privacySuccess) {
                privacySuccess.textContent = `Room is now private! Share this code: ${data.code}`;
                privacySuccess.style.display = 'block';
            }
            if (togglePrivacyBtn) {
                togglePrivacyBtn.textContent = 'Make Public';
                togglePrivacyBtn.style.backgroundColor = '#16a34a';
            }
        } else {
            // Room was made public
            roomIsPrivate = false;
            window.location.reload();
        }
    } catch (error) {
        if (privacyError) {
            privacyError.textContent = 'Unable to update privacy settings.';
            privacyError.style.display = 'block';
        }
        console.error('Error updating privacy:', error);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fetch timer state from server
async function fetchTimerState() {
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/timer/state/`);
        const state = await response.json();
        updateTimerDisplay(state);
    } catch (error) {
        console.error('Error fetching timer state:', error);
    }
}

function updateTimerDisplay(state) {
    const minutes = Math.floor(state.time_left / 60);
    const seconds = state.time_left % 60;
    
    // Update display
    document.getElementById('timer-display').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Update mode
    const modeText = state.mode === 'work' ? 'Work Session' : 'Break Time';
    document.getElementById('timer-mode').textContent = modeText;
    const accentPrimary = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
    const success = getComputedStyle(document.documentElement).getPropertyValue('--success');
    document.getElementById('timer-display').style.color = 
        state.mode === 'work' ? accentPrimary : success;
    
    // Animate character based on timer state
    const character = document.getElementById('timer-character');
    if (character) {
        if (state.is_running) {
            character.classList.add('dancing');
            character.classList.remove('celebrate');
        } else {
            character.classList.remove('dancing');
        }
        
        // Celebrate when timer reaches 0
        if (state.time_left === 0 && !character.classList.contains('celebrate')) {
            character.classList.add('celebrate');
            setTimeout(() => {
                character.classList.remove('celebrate');
            }, 1500);
        }
    }
    
    // Update button visibility (only for creator)
    if (IS_CREATOR) {
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        
        if (state.is_running) {
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'block';
        } else {
            startBtn.style.display = 'block';
            pauseBtn.style.display = 'none';
        }
    }
    
    // Play notification when mode changes
    if (lastMode !== state.mode && state.time_left === state.duration) {
        playNotificationSound();
        const message = state.mode === 'work' ? 
            'Break finished! Time to work!' : 
            'Work session finished! Take a break!';
        
        // Show notification
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Pomodoro Timer', { body: message });
        } else {
            alert(message);
        }
    }
    lastMode = state.mode;
}

async function startTimer() {
    if (!IS_CREATOR) return;
    
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/timer/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        const state = await response.json();
        updateTimerDisplay(state);
    } catch (error) {
        console.error('Error starting timer:', error);
    }
}

async function pauseTimer() {
    if (!IS_CREATOR) return;
    
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/timer/pause/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        const state = await response.json();
        updateTimerDisplay(state);
    } catch (error) {
        console.error('Error pausing timer:', error);
    }
}

async function resetTimer() {
    if (!IS_CREATOR) return;
    
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/timer/reset/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        const state = await response.json();
        updateTimerDisplay(state);
    } catch (error) {
        console.error('Error resetting timer:', error);
    }
}

function playNotificationSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log('Audio notification not supported');
    }
}

// Function to update presence and get active user count
async function updatePresence() {
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/presence/`);
        const data = await response.json();
        
        // Update the count display
        const countElement = document.getElementById('active-user-count');
        if (countElement) {
            countElement.textContent = data.active_count;
        }
        
        // Optional: Add pulse animation when count > 1
        const badge = document.getElementById('active-users-badge');
        if (badge && data.active_count > 1) {
            badge.style.animation = 'pulse 2s ease-in-out infinite';
        } else if (badge) {
            badge.style.animation = 'none';
        }
    } catch (error) {
        console.error('Error updating presence:', error);
    }
}

// Initialize everything when page loads
window.addEventListener('DOMContentLoaded', () => {
    // Add CSS animations for pulse effect and timer character
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 8px var(--shadow);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 4px 12px var(--shadow);
            }
        }
        
        /* Peanut Butter Jelly Dance Animation */
        @keyframes pbj-body {
            0% { transform: translateX(-30px) rotate(-15deg) scaleX(0.9); }
            25% { transform: translateX(-15px) rotate(-8deg) scaleX(0.95); }
            50% { transform: translateX(30px) rotate(15deg) scaleX(0.9); }
            75% { transform: translateX(15px) rotate(8deg) scaleX(0.95); }
            100% { transform: translateX(-30px) rotate(-15deg) scaleX(0.9); }
        }

        @keyframes pbj-arms {
            0% { transform: rotate(-90deg) translateX(-10px); }
            25% { transform: rotate(-45deg) translateX(-5px); }
            50% { transform: rotate(90deg) translateX(10px); }
            75% { transform: rotate(45deg) translateX(5px); }
            100% { transform: rotate(-90deg) translateX(-10px); }
        }

        @keyframes pbj-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes headband-bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-2px) scale(1.05); }
        }

        /* Apply PBJ dance when timer is running */
        #timer-character.dancing {
            animation: pbj-body 1s ease-in-out infinite;
        }

        #timer-character.dancing #left-arm {
            animation: pbj-arms 1s ease-in-out infinite;
            transform-origin: 37px 75px;
        }

        #timer-character.dancing #right-arm {
            animation: pbj-arms 1s ease-in-out infinite reverse;
            transform-origin: 83px 75px;
        }

        #timer-character.dancing #left-leg {
            animation: pbj-bounce 0.5s ease-in-out infinite;
            transform-origin: bottom;
        }

        #timer-character.dancing #right-leg {
            animation: pbj-bounce 0.5s ease-in-out infinite;
            transform-origin: bottom;
        }

        #timer-character.dancing .headband {
            animation: headband-bounce 0.5s ease-in-out infinite;
        }
        
        /* Celebration animation when timer completes */
        @keyframes celebrate {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
            }
            25% { 
                transform: scale(1.3) rotate(-15deg);
            }
            50% { 
                transform: scale(1.3) rotate(0deg);
            }
            75% { 
                transform: scale(1.3) rotate(15deg);
            }
        }
        
        #timer-character.celebrate {
            animation: celebrate 0.5s ease-in-out 3;
        }
    `;
    document.head.appendChild(style);
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Initial timer fetch
    fetchTimerState();
    
    // Poll every second for timer updates
    pollInterval = setInterval(fetchTimerState, 1000);
    
    // Real-time chat initialization
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    
    if (messageInput) {
        // Character counter
        messageInput.addEventListener('input', () => {
            const currentLength = messageInput.value.length;
            document.getElementById('current-chars').textContent = currentLength;
        });
    }
    
    if (messageForm) {
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const content = messageInput.value.trim();
            if (!content) {
                return;
            }
            
            // Clear input immediately for better UX
            messageInput.value = '';
            document.getElementById('current-chars').textContent = '0';
            
            // Send message
            await sendMessage(content);
        });
    }
    
    // Initialize last message ID
    updateLastMessageId();
    
    // Convert initial template-rendered message timestamps to local timezone
    const initialTimestamps = document.querySelectorAll('[data-timestamp-iso]');
    initialTimestamps.forEach(element => {
        const isoString = element.getAttribute('data-timestamp-iso');
        if (isoString) {
            const timestampElement = element.querySelector('.message-timestamp');
            if (timestampElement) {
                timestampElement.textContent = formatTimestamp(isoString);
            }
        }
    });
    
    // Initial message fetch
    fetchMessages();
    
    // Poll for new messages every 1.5 seconds
    messagePollInterval = setInterval(fetchMessages, 1500);
    
    // Initial presence update
    updatePresence();
    
    // Poll for presence updates every 5 seconds
    presencePollInterval = setInterval(updatePresence, 5000);
});

// Clean up polling when leaving page
window.addEventListener('beforeunload', () => {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
    if (messagePollInterval) {
        clearInterval(messagePollInterval);
    }
    if (presencePollInterval) {
        clearInterval(presencePollInterval);
    }
});

// -----------------------------
// REAL-TIME CHAT FUNCTIONALITY
// -----------------------------

// Format timestamp from UTC ISO string to local timezone
function formatTimestamp(utcString) {
    const date = new Date(utcString);
    return date.toLocaleString('en-US', {
        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        month: 'short',
        day: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Track last message ID to only show new messages
function updateLastMessageId() {
    const messageElements = document.querySelectorAll('[data-message-id]');
    if (messageElements.length > 0) {
        const ids = Array.from(messageElements).map(el => parseInt(el.getAttribute('data-message-id')));
        lastMessageId = Math.max(...ids);
    } else {
        lastMessageId = null;
    }
}

// Fetch messages from server
async function fetchMessages() {
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/messages/`);
        const data = await response.json();
        updateChatMessages(data.messages);
    } catch (error) {
        console.error('Error fetching messages:', error);
    }
}

// Update chat messages display
function updateChatMessages(messages) {
    const chatContainer = document.getElementById('chat-messages');
    const noMessagesP = document.getElementById('no-messages');
    
    // Get existing message IDs from DOM
    const existingIds = new Set(
        Array.from(document.querySelectorAll('[data-message-id]'))
            .map(el => parseInt(el.getAttribute('data-message-id')))
    );
    
    // Get fetched message IDs from server
    const fetchedIds = new Set(messages.map(msg => msg.id));
    
    // Remove messages that no longer exist in the fetched list (real-time deletion)
    existingIds.forEach(msgId => {
        if (!fetchedIds.has(msgId)) {
            const messageElement = document.querySelector(`[data-message-id="${msgId}"]`);
            if (messageElement) {
                messageElement.remove();
            }
        }
    });
    
    // Show "no messages" text if no messages exist
    if (messages.length === 0 && !document.getElementById('no-messages')) {
        const noMsgP = document.createElement('p');
        noMsgP.id = 'no-messages';
        noMsgP.textContent = 'No messages yet. Start the conversation!';
        chatContainer.appendChild(noMsgP);
    }
    
    // Remove "no messages" text if we have messages
    if (messages.length > 0 && noMessagesP) {
        noMessagesP.remove();
    }
    
    // Add new messages that don't already exist
    let hasNewMessages = false;
    messages.forEach(msg => {
        if (!existingIds.has(msg.id)) {
            addMessageToChat(msg);
            hasNewMessages = true;
        }
    });
    
    // Auto-scroll to bottom if new messages were added
    if (hasNewMessages) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
}

// Add a single message to the chat
function addMessageToChat(msg) {
    const chatContainer = document.getElementById('chat-messages');
    const noMessagesP = document.getElementById('no-messages');
    
    // Remove "no messages" text if it exists
    if (noMessagesP) {
        noMessagesP.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.setAttribute('data-message-id', msg.id);
    
    const isOwn = msg.is_own;
    const accentPrimary = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();
    const accentHover = getComputedStyle(document.documentElement).getPropertyValue('--accent-hover').trim();
    const bgTertiary = getComputedStyle(document.documentElement).getPropertyValue('--bg-tertiary').trim();
    const textPrimary = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();
    messageDiv.style.cssText = `margin-bottom:15px;padding:10px 15px;border-radius:10px;max-width:70%;word-wrap:break-word;overflow-wrap:break-word;word-break:break-word;position:relative;
        ${isOwn ? `background:linear-gradient(135deg, ${accentPrimary}, ${accentHover});color:white;margin-left:auto;` : `background-color:${bgTertiary};color:${textPrimary};`}`;
    
    let deleteButton = '';
    if (isOwn) {
        deleteButton = `
            <button type="button" 
                    onclick="deleteMessage(${msg.id})"
                    style="background-color:transparent;border:none;color:white;cursor:pointer;font-size:18px;padding:0;line-height:1;margin-left:10px;"
                    title="Delete message">
                Ã—
            </button>`;
    }
    
    // Format timestamp to local timezone
    const formattedTimestamp = formatTimestamp(msg.timestamp);
    const textSecondary = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
    
    messageDiv.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:start;">
            <div style="flex:1;">
                <strong>${escapeHtml(msg.user)}</strong><br>
                ${escapeHtml(msg.content)}
                <div style="font-size:0.8em;${isOwn ? 'color:rgba(255,255,255,0.8);' : `color:${textSecondary};`}margin-top:4px;">
                    ${escapeHtml(formattedTimestamp)}
                </div>
            </div>
            ${deleteButton}
        </div>`;
    
    chatContainer.appendChild(messageDiv);
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Send message via AJAX
async function sendMessage(content) {
    try {
        const formData = new FormData();
        formData.append('content', content);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/send-message/`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Message will be picked up by polling, but we can add it immediately for instant feedback
            addMessageToChat(data.message);
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } else {
            console.error('Error sending message:', data.error);
            alert('Failed to send message. Please try again.');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message. Please try again.');
    }
}

// Delete message via AJAX (real-time deletion)
async function deleteMessage(messageId) {
    if (!confirm('Delete this message?')) {
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        // Create a form submission via fetch to match Django's expected POST
        const response = await fetch(`/studybuddy/message/${messageId}/delete/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        // Remove message from DOM immediately for instant feedback
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            messageElement.remove();
        }
        
        // Check if we need to show "no messages" text
        const chatContainer = document.getElementById('chat-messages');
        const remainingMessages = chatContainer.querySelectorAll('[data-message-id]');
        if (remainingMessages.length === 0) {
            const noMsgP = document.createElement('p');
            noMsgP.id = 'no-messages';
            noMsgP.textContent = 'No messages yet. Start the conversation!';
            chatContainer.appendChild(noMsgP);
        }
        
        // Next poll will confirm the deletion from server
        // If deletion failed on server, the message will reappear on next poll
    } catch (error) {
        console.error('Error deleting message:', error);
        alert('Failed to delete message. Please try again.');
    }
}

// Clean up message and presence polling when leaving page
window.addEventListener('beforeunload', () => {
    if (messagePollInterval) {
        clearInterval(messagePollInterval);
    }
    if (presencePollInterval) {
        clearInterval(presencePollInterval);
    }
});
</script>
{% endblock %}
