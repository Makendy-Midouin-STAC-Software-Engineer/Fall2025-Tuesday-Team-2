{% extends 'studybuddy/base.html' %}
{% block title %}{{ room.name }}{% endblock %}
{% block content %}

<!-- ðŸ”’ Private Room Banner -->
{% if room.is_private %}
<div style="background-color:#fef08a;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;">
    ðŸ”’ <strong>Private Room</strong><br>
    Share this code to invite others: <strong>{{ room.access_code }}</strong>
</div>
{% endif %}

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
    <h2 style="margin:0;">{{ room.name }}</h2>
    {% if room.created_by == request.user %}
    <a href="{% url 'studybuddy:room_delete' room.id %}" 
       style="background-color:#dc2626;color:white;padding:8px 16px;border-radius:8px;text-decoration:none;font-size:14px;">
        Delete Room
    </a>
    {% endif %}
</div>

<div style="display:flex;gap:20px;">
    <!-- Chat Section -->
    <div style="flex:2;">
        <div style="border:1px solid #ddd;padding:15px;border-radius:8px;height:400px;overflow-y:auto;margin-bottom:15px;">
            {% for message in messages %}
                <div style="margin-bottom:15px;padding:10px 15px;border-radius:10px;max-width:70%;word-wrap:break-word;position:relative;
                    {% if message.user == request.user %}background-color:#2563eb;color:white;margin-left:auto;{% else %}background-color:#e5e7eb;color:#111;{% endif %}">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div style="flex:1;">
                            <strong>{{ message.user.username }}</strong><br>
                            {{ message.content }}
                            <div style="font-size:0.8em;{% if message.user == request.user %}color:#e0e0e0;{% else %}color:#555;{% endif %}margin-top:4px;">
                                {{ message.timestamp|date:"M d, Y H:i" }}
                            </div>
                        </div>
                        {% if message.user == request.user %}
                        <form method="POST" action="{% url 'studybuddy:message_delete' message.id %}" style="margin-left:10px;" onsubmit="return confirm('Delete this message?');">
                            {% csrf_token %}
                            <button type="submit" 
                                    style="background-color:transparent;border:none;color:{% if message.user == request.user %}white{% else %}#666{% endif %};cursor:pointer;font-size:18px;padding:0;line-height:1;"
                                    title="Delete message">
                                Ã—
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <p>No messages yet. Start the conversation!</p>
            {% endfor %}
        </div>

        <form method="POST" style="display:flex;align-items:center;">
            {% csrf_token %}
            <textarea name="content" rows="2" placeholder="Type your message..." required
                      style="flex:1;resize:none;padding:10px;border-radius:8px;border:1px solid #ccc;font-family:inherit;"></textarea>
            <button type="submit"
                    style="background-color:#2563eb;border:none;color:white;padding:10px 20px;border-radius:8px;margin-left:10px;cursor:pointer;">
                Send
            </button>
        </form>
    </div>

    <!-- Pomodoro Timer Section -->
    <div style="flex:1;min-width:250px;">
        <div style="border:1px solid #ddd;padding:20px;border-radius:8px;background-color:#f8f9fa;">
            <h3 style="margin-top:0;text-align:center;color:#333;">Pomodoro Timer</h3>
            {% if room.created_by != request.user %}
            <div style="background-color:#fef3c7;padding:8px;border-radius:6px;margin-bottom:15px;text-align:center;font-size:12px;color:#92400e;">
                Only {{ room.created_by.username }} (room creator) can control the timer
            </div>
            {% endif %}
            
            <div id="timer-display" style="font-size:48px;font-weight:bold;text-align:center;margin:20px 0;color:#2563eb;">
                25:00
            </div>
            
            <div style="text-align:center;margin-bottom:15px;">
                <span id="timer-mode" style="font-size:16px;color:#666;">Work Session</span>
            </div>
            
            {% if room.created_by == request.user %}
            <div style="display:flex;flex-direction:column;gap:10px;">
                <button id="start-btn" onclick="startTimer()" 
                        style="background-color:#16a34a;color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;">
                    Start
                </button>
                <button id="pause-btn" onclick="pauseTimer()" 
                        style="background-color:#f59e0b;color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;display:none;">
                    Pause
                </button>
                <button onclick="resetTimer()" 
                        style="background-color:#6b7280;color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;">
                    Reset
                </button>
            </div>
            {% else %}
            <div style="text-align:center;padding:12px;background-color:#e5e7eb;border-radius:8px;color:#666;font-size:14px;">
                Timer controlled by room creator
            </div>
            {% endif %}
            
            <div style="margin-top:15px;padding:10px;background-color:#e5e7eb;border-radius:8px;font-size:14px;">
                <strong>Settings:</strong><br>
                Work: 25 min<br>
                Break: 5 min<br>
                <div style="margin-top:5px;font-size:12px;color:#666;">
                    <em>Synced across all users in room</em>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const ROOM_ID = {{ room.id }};
const IS_CREATOR = {{ room.created_by.id }} === {{ request.user.id }};
let pollInterval = null;
let lastMode = 'work';

// Fetch timer state from server
async function fetchTimerState() {
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/timer/state/`);
        const state = await response.json();
        updateTimerDisplay(state);
    } catch (error) {
        console.error('Error fetching timer state:', error);
    }
}

function updateTimerDisplay(state) {
    const minutes = Math.floor(state.time_left / 60);
    const seconds = state.time_left % 60;
    
    document.getElementById('timer-display').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const modeText = state.mode === 'work' ? 'Work Session' : 'Break Time';
    document.getElementById('timer-mode').textContent = modeText;
    document.getElementById('timer-display').style.color = 
        state.mode === 'work' ? '#2563eb' : '#16a34a';
    
    if (IS_CREATOR) {
        const startBtn = document.getElementById('start-btn');
        const pauseBtn = document.getElementById('pause-btn');
        
        if (state.is_running) {
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'block';
        } else {
            startBtn.style.display = 'block';
            pauseBtn.style.display = 'none';
        }
    }
    
    if (lastMode !== state.mode && state.time_left === state.duration) {
        playNotificationSound();
        const message = state.mode === 'work' ? 
            'Break finished! Time to work!' : 
            'Work session finished! Take a break!';
        
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Pomodoro Timer', { body: message });
        } else {
            alert(message);
        }
    }
    lastMode = state.mode;
}

async function startTimer() {
    if (!IS_CREATOR) return;
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/timer/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        const state = await response.json();
        updateTimerDisplay(state);
    } catch (error) {
        console.error('Error starting timer:', error);
    }
}

async function pauseTimer() {
    if (!IS_CREATOR) return;
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/timer/pause/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        const state = await response.json();
        updateTimerDisplay(state);
    } catch (error) {
        console.error('Error pausing timer:', error);
    }
}

async function resetTimer() {
    if (!IS_CREATOR) return;
    try {
        const response = await fetch(`/studybuddy/room/${ROOM_ID}/timer/reset/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        const state = await response.json();
        updateTimerDisplay(state);
    } catch (error) {
        console.error('Error resetting timer:', error);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function playNotificationSound() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (e) {
        console.log('Audio notification not supported');
    }
}

window.addEventListener('DOMContentLoaded', () => {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    fetchTimerState();
    pollInterval = setInterval(fetchTimerState, 1000);
});

window.addEventListener('beforeunload', () => {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
});
</script>
{% endblock %}
