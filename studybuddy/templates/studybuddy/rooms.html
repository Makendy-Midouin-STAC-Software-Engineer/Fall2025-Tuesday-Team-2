{% extends 'studybuddy/base.html' %}
{% block title %}Study Rooms{% endblock %}
{% block content %}
<style>
    .rooms-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    /* CREATE ROOM CARD (keeps your dark theme + shadow) */
    .create-room-form {
        background: var(--bg-tertiary);
        padding: 1.75rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 25px var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
    }

    /* Title */
    .create-room-title {
        font-size: 1.25rem;
        font-weight: 800;
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Labels */
    .create-room-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 0.35rem;
    }

    /* INPUTS – restore original thickness + style */
    .create-room-field input,
    .create-room-field textarea {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 0.9rem 1rem;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 1rem;
        resize: vertical;
    }

    /* TEXTAREA height */
    .create-room-field textarea {
        min-height: 110px;
    }

    /* RESTORE ORIGINAL CREATE BUTTON */
    .create-btn {
        width: 100%;
        background: var(--success);
        color: white;
        padding: 0.9rem;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: 0.25s ease;
    }

    .create-btn:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
    }

    .create-btn:active {
        transform: none;
    }

    /* Mobile stacking */
    @media (max-width: 768px) {
        .create-room-row {
            flex-direction: column;
        }

        .create-room-actions {
            justify-content: stretch;
        }

        .create-btn {
            width: 100%;
            justify-content: center;
        }
    }

    .room-card:hover {
        border-color: var(--accent-primary);
        box-shadow: 0 6px 12px var(--shadow);
        transform: translateY(-2px);
    }

    .room-name:hover {
        text-decoration: underline;
    }

    .empty-state {
        background: var(--bg-tertiary);
        padding: 3rem 2rem;
        border-radius: 16px;
        text-align: center;
        color: var(--text-secondary);
        border: 2px dashed var(--border-color);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .private-room-section {
        margin-top: 3rem;
        padding: 2rem;
        background: linear-gradient(135deg, rgba(8, 145, 178, 0.1), rgba(6, 182, 212, 0.1));
        border-radius: 16px;
        border: 2px solid var(--accent-primary);
    }

    [data-theme="dark"] .private-room-section {
        background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 133, 85, 0.1));
    }

    .private-room-section h2 {
        color: var(--accent-primary);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .private-room-section p {
        color: var(--text-secondary);
        margin-bottom: 1.5rem;
    }

    .join-form {
        display: flex;
        gap: 1rem;
        align-items: stretch;
    }

    .join-form input {
        flex: 1;
        padding: 1rem;
        border-radius: 12px;
        border: 2px solid var(--border-color);
        font-size: 1.125rem;
        font-weight: 600;
        letter-spacing: 3px;
        text-align: center;
        text-transform: uppercase;
    }

    .join-btn {
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-hover));
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .join-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px var(--shadow);
    }

    @media (max-width: 768px) {
        .room-card {
            flex-direction: column;
            align-items: flex-start;
        }

        .join-form {
            flex-direction: column;
        }

        .form-row {
            flex-direction: column;
        }
    }

    /* Entire card stays full width */
    .room-card {
        width: 90%;
        margin-left: auto;
        margin-right: auto;
        background: var(--bg-tertiary);
        padding: 0.75rem 1rem;
        border-radius: 14px;
        border: 1px solid var(--border-color);
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;   /* reduces height */
    }

    /* Top horizontal strip */
    .room-top {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
    }

    .room-info-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap; /* allows wrap when needed */
    }

    /* Room title */
    .room-name {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--accent-primary);
        text-decoration: none;
        margin-right: 0.5rem;
    }

    /* Creator + date inline */
    .room-meta-inline {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
        opacity: 0.75;
        font-size: 0.75rem;
    }

    .room-meta-inline i {
        font-size: 0.75rem;
        opacity: 0.8;
    }

    /* Trash icon button */
    .delete-icon {
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;

        background: rgba(239, 68, 68, 0.16);
        border: 1px solid rgba(239, 68, 68, 0.35);

        border-radius: 8px;
        cursor: pointer;

        transition: 0.2s ease;
    }

    .delete-icon i {
        color: #ef4444 !important; /* force correct red, stops blue/purple */
        font-size: 0.85rem;
    }

    .delete-icon:hover {
        background: rgba(239, 68, 68, 0.26);
        transform: scale(1.05);
    }

    /* Description sits under everything */
    .room-description {
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    .rooms-scroll-wrapper {
    max-height: 800px; /* Adjust: 400px/600px depending on your preference */
    overflow-y: auto;
    padding-right: 0.5rem;
    margin-bottom: 2rem;

    /* Smooth scroll */
    scroll-behavior: smooth;

    /* Subtle inset shadow at top & bottom */
    mask-image: linear-gradient(
        to bottom,
        transparent,
        black 3%,
        black 97%,
        transparent
    );

    /* Prevent horizontal scroll */
    overflow-x: hidden;
    }

    /* Hide scrollbar but keep scrollability (WebKit) */
    .rooms-scroll-wrapper::-webkit-scrollbar {
        width: 8px;
    }

    .rooms-scroll-wrapper::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 8px;
    }

    .rooms-scroll-wrapper::-webkit-scrollbar-thumb:hover {
        background: var(--accent-primary);
    }

    .room-badges {
    display: flex;
    gap: 0.3rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
    }

    .badge {
        padding: 0.1rem 0.35rem;
        border-radius: 6px;
        font-size: 0.60rem;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
    }

    .badge-private {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.3);
    }

    .badge-public {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        border-color: rgba(34, 197, 94, 0.3);
    }

    .badge-owner {
        background: rgba(234, 179, 8, 0.15);
        color: #eab308;
        border-color: rgba(234, 179, 8, 0.3);
    }

    /* ─────────────────────────────────────────────
       UTILITY BAR (Search + Private Room Join)
       ───────────────────────────────────────────── */
    .rooms-utility-bar {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 1rem;
        margin-bottom: 2.25rem;

        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 14px;
        box-shadow: 0 6px 14px var(--shadow);
        padding: 1rem 1.25rem;
    }

    .utility-left,
    .utility-right {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    /* Search field (long) */
    #room-search {
        flex: 1;
        padding: 0.75rem 1rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 0.95rem;
    }

    /* Private code field (short) */
    #private-code {
        width: 220px;
        padding: 0.75rem 0.75rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        text-transform: uppercase;
        text-align: center;
        letter-spacing: 2px;
        font-weight: 600;
        color: var(--text-primary);
    }

    /* Buttons */
    .utility-btn {
        height: 42px;
        width: 48px;

        background: var(--accent-primary);
        color: white;

        display: flex;
        justify-content: center;
        align-items: center;

        border: none;
        border-radius: 10px;
        cursor: pointer;

        transition: 0.2s ease;
    }

    .utility-btn:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
    }

    .utility-btn i {
        font-size: 1rem;
    }

    /* Mobile: stack */
    @media (max-width: 768px) {
        .rooms-utility-bar {
            grid-template-columns: 1fr;
        }
    }

</style>

<div class="rooms-header">
    <h1><i class="fas fa-users"></i> Study Rooms</h1>
</div>

<form id="create-room-form" method="POST" class="create-room-form">
    {% csrf_token %}

    <div class="create-room-field">
        <input type="text" name="name" placeholder="Room name" required>
    </div>

    <div class="create-room-field">
        <textarea name="description" placeholder="What’s this room about?"></textarea>
    </div>

    <button type="submit" class="create-btn">
        <i class="fas fa-plus-circle"></i>
        Create Room
    </button>
</form>

<div class="rooms-utility-bar">

    <div class="utility-left">
        <input type="text" id="room-search" placeholder="Search rooms...">
        <button id="search-btn" class="utility-btn">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <div class="utility-right">
        <input type="text" id="private-code" maxlength="10" placeholder="Private Room Code">
        <button id="join-private-btn" class="utility-btn">
            <i class="fas fa-sign-in-alt"></i>
        </button>
    </div>

</div>

<div class="rooms-scroll-wrapper">
    <div id="rooms-container">
        {% for room in rooms %}
            <div class="room-card" data-room-id="{{ room.id }}">

                <!-- TOP HORIZONTAL BAR -->
                <div class="room-top">

                    <!-- Column 1: Name -->
                    <a href="{% url 'studybuddy:room_detail' room.id %}" class="room-name">
                        {{ room.name }}
                    </a>

                    <!-- Column 2: Tags + Creator + Date -->
                    <div class="room-info-row">

                        <div class="room-badges">
                            {% if room.is_private %}
                                <span class="badge badge-private"><i class="fas fa-lock"></i> Private</span>
                            {% else %}
                                <span class="badge badge-public"><i class="fas fa-globe"></i> Public</span>
                            {% endif %}
                            {% if room.created_by == request.user %}
                                <span class="badge badge-owner"><i class="fas fa-crown"></i> Owner</span>
                            {% endif %}
                        </div>

                        <div class="room-meta-inline">
                            <span><i class="fas fa-user"></i> {{ room.created_by.username }}</span>
                            <span><i class="fas fa-calendar-alt"></i> {{ room.created_at|date:"M d, Y" }}</span>
                        </div>

                    </div>

                    <!-- Column 3: Trash -->
                    {% if room.created_by == request.user %}
                        <a href="{% url 'studybuddy:room_delete' room.id %}" class="delete-icon">
                            <i class="fas fa-trash"></i>
                        </a>
                    {% endif %}

                </div>

                <!-- Description under top bar -->
                <div class="room-description">
                    {{ room.description }}
                </div>

            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-door-open"></i>
                <p>No public rooms yet. Create one above!</p>
            </div>
        {% endfor %}
    </div>
</div> <!-- end scroll wrapper -->

<script>
let roomsPollInterval = null;
let searchActive = false;

// Auto-uppercase the room code input
document.addEventListener('DOMContentLoaded', function() {
    const codeInput = document.querySelector('input[name="room_code"]');
    if (codeInput) {
        codeInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });
    }

    // Fetch rooms from server
    async function fetchRooms() {
        try {
            const response = await fetch('/studybuddy/rooms/api/');
            const data = await response.json();
            updateRoomsList(data.rooms);
        } catch (error) {
            console.error('Error fetching rooms:', error);
        }
    }

    // Update rooms list display
    function updateRoomsList(rooms) {
        const existingRooms = document.querySelectorAll('[data-room-id]');
        const existingIds = new Set(
            Array.from(existingRooms).map(el => parseInt(el.getAttribute('data-room-id')))
        );
        const fetchedIds = new Set(rooms.map(room => room.id));

        // Remove rooms that no longer exist or became private
        existingIds.forEach(roomId => {
            if (!fetchedIds.has(roomId)) {
                const roomElement = document.querySelector(`[data-room-id="${roomId}"]`);
                if (roomElement) {
                    roomElement.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => roomElement.remove(), 300);
                }
            }
        });

        // Add new rooms that don't exist yet
        rooms.forEach(room => {
            if (!existingIds.has(room.id)) {
                addRoomToDOM(room);
            }
        });

        // Update empty state
        const roomsList = document.querySelectorAll('[data-room-id]');
        const emptyDiv = document.querySelector('.empty-state');
        const container = document.getElementById('rooms-container');

        if (rooms.length === 0 && !emptyDiv) {
            const emptyMsg = document.createElement('div');
            emptyMsg.className = 'empty-state';
            emptyMsg.innerHTML = '<i class="fas fa-door-open"></i><p>No public rooms yet. Create one above!</p>';
            container.appendChild(emptyMsg);
        } else if (rooms.length > 0 && emptyDiv) {
            emptyDiv.remove();
        }
    }

    // Add a single room to the DOM using the *new compact layout*
    function addRoomToDOM(room) {
        const container = document.getElementById('rooms-container');
        const emptyMsg = document.querySelector('.empty-state');

        if (emptyMsg) emptyMsg.remove();

        const roomDiv = document.createElement('div');
        roomDiv.setAttribute('data-room-id', room.id);
        roomDiv.className = 'room-card';
        roomDiv.style.animation = 'slideIn 0.3s ease';

        const createdDate = new Date(room.created_at).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });

        roomDiv.innerHTML = `
            <div class="room-top">

                <!-- Column 1: Name -->
                <a href="/studybuddy/room/${room.id}/" class="room-name">
                    ${escapeHtml(room.name)}
                </a>

                <!-- Column 2: Info Row (badges + meta) -->
                <div class="room-info-row">
                    <div class="room-badges">
                        ${room.is_private ?
                            `<span class="badge badge-private"><i class="fas fa-lock"></i> Private</span>` :
                            `<span class="badge badge-public"><i class="fas fa-globe"></i> Public</span>`
                        }
                        ${room.is_creator ?
                            `<span class="badge badge-owner"><i class="fas fa-crown"></i> Owner</span>` :
                            ``
                        }
                    </div>
                    <div class="room-meta-inline">
                        <span><i class="fas fa-user"></i> ${escapeHtml(room.created_by)}</span>
                        <span><i class="fas fa-calendar-alt"></i> ${createdDate}</span>
                    </div>
                </div>

                <!-- Column 3: Trash -->
                ${room.is_creator ? `
                    <a href="/studybuddy/room/${room.id}/delete/" class="delete-icon">
                        <i class="fas fa-trash"></i>
                    </a>` : ``}
            </div>

            <div class="room-description">
                ${escapeHtml(room.description)}
            </div>
        `;

        container.insertBefore(roomDiv, container.firstChild);
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initial fetch
    fetchRooms();

    // Poll for room updates every 2 seconds
    roomsPollInterval = setInterval(() => {
        if (!searchActive) {
            fetchRooms();
        }
    }, 2000);

    // Clean up polling when leaving page
    window.addEventListener('beforeunload', () => {
        if (roomsPollInterval) {
            clearInterval(roomsPollInterval);
        }
    });

    // --- SEARCH BUTTON ---
    const searchBtn = document.getElementById("search-btn");
    const searchInput = document.getElementById("room-search");

    if (searchBtn && searchInput) {
        searchBtn.addEventListener("click", () => {
            const query = searchInput.value.trim();
            if (query !== "") {
                searchActive = true;
                stopRoomPolling();

                fetch(`/studybuddy/rooms/search/?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => updateRoomsList(data.rooms));
            }
        });
    }

    searchInput.addEventListener("input", () => {
        if (searchInput.value.trim() === "") {
            searchActive = false;

            if (!roomsPollInterval) {
                roomsPollInterval = setInterval(() => {
                    if (!searchActive) {
                        fetchRooms();
                    }
                }, 2000);
            }

            fetchRooms();
        }
    });


    // --- JOIN PRIVATE ROOM BUTTON (POST like original form) ---
    const joinPrivateBtn = document.getElementById("join-private-btn");
    const privateCodeInput = document.getElementById("private-code");

    if (joinPrivateBtn && privateCodeInput) {
        joinPrivateBtn.addEventListener("click", () => {
            const code = privateCodeInput.value.trim().toUpperCase();
            if (!code) return;

            const csrf = document.querySelector("[name=csrfmiddlewaretoken]").value;

            fetch("/studybuddy/rooms/join/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrf
                },
                body: "room_code=" + encodeURIComponent(code)
            })
            .then(res => {
                // Django redirects after POST — fetch sees it as redirected=true
                if (res.redirected) {
                    window.location.href = res.url;
                } else {
                    // fallback: manually reload or show error
                    window.location.reload();
                }
            })
            .catch(err => console.error("Join failed:", err));
        });
    }

        function stopRoomPolling() {
        if (roomsPollInterval) {
            clearInterval(roomsPollInterval);
            roomsPollInterval = null;
        }
    }
});
</script>
{% endblock %}


